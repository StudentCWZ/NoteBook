# NoSQL 入门和概述
## 入门概述
### 使用 NoSQL 背景
1. 单机 MySQL 的美好年代
    - 在 90 年代，一个网站的访问量一般都不大，用单个数据库完全可以轻松应付。在那个时候，更多的都是静态网页，动态交互类型的网站不多。
    - 单机 MySQL 中数据存储的瓶颈
        - 数据量的总大小一个机器放不下时
        - 数据的索引(B+ Tree)一个机器的内存放不下时
        - 访问量(读写混合)一个实例不能承受

2. Memcached(缓存) + MySQL + 垂直拆分
    - 随着访问量的上升，几乎大部分使用 MySQL 架构的网站在数据库上都开始出现了性能问题，web 程序不再仅仅专注在功能上，同时也在追求性能。
    - 程序员们开始大量的使用缓存技术来缓解数据库的压力。
    - 开始比较流行的是通过文件缓存来缓解数据库压力，但是当访问量继续增大的时候，多台 web 及其通过文件缓存不能共享，大量的小文件缓存也带来了比较大的 IO 压力，这时候，Memcached 就自然的成为一个非常时尚的技术产品。

3. MySQL 主从读写分离
    - 由于数据库的写入压力增加，Memcached 只能缓解数据库的读取压力，读写集中在一个数据库上让数据不堪重负，大部分网站开始使用主从复制技术来达到读写分离，以提高读写性能和读库的可扩展性。
    - MySQL 的 master-slave 模式成为这个时代的标配了。

4. 分表分库 + 水平拆分 + MySQL 集群
    - 在 Memcached 的高速缓存，MySQL 的主从复制，读写分离的基础之上，这时 MySQL 主库的写压力开始出现瓶颈，而数据量的持续猛增，由于 MyISAM 使用表锁，在高并发下会出现严重的锁问题，大量的高并发 MySQL 应用开始使用个 InnoDB 引擎代替 MyISAM 。
    - 同时开始流行分表分库来缓解写的压力和数据增长的扩展问题。这个时候，分表分库成了一个热门技术，是面试的热门问题，也是业界讨论的热门技术问题。
    - 虽然 MySQL 推出了 MySQL Cluster 集群，但性能也不能很好满足互联网的要求，只是在可靠性上提供了非常大的保证。

5. MySQL 扩展性瓶颈
    - MySQL 数据库也经常存储一些大文本字段，导致数据表非常的大，在做数据库恢复的时候就导致非常慢，不容易快速恢复数据库。
    - MySQL 的扩展性差，大数据下 IO 压力大，表结构更改困难，正是当前使用 MySQL 的开发人员面临的问题。

6. 使用 NoSQL 原因
    - 用户的个人信息，社交网络，地理位置，用户生成的数据和用户操作日志已经成倍的增加。
    - 我们如果要对这些用户数据进行挖掘，那 MySQL 数据库已经不适合这些应用了，NoSQL 数据库的发展却能很好地处理这些大的数据。

## NoSQL 是什么
1. NoSQL 基本介绍
    - NoSQL(Not only SQL)，意即不仅仅是 SQL ，泛指非关系型数据库。
    - 随着互联网 web2.0 网站的兴起，传统的关系型数据库在应付 web2.0 网站，特别是超大规模和高并发的 SNS 类型的 web2.0 纯动态网页已经显得力不从心，暴露了很多难以克服的问题，而非关系型数据库则由于本身的特点得到了非常迅速的发展。
    - NoSQL 数据库的产生就是为了解决大规模数据集合多重数据种类带来的挑战，尤其是大数据应用难题，包括大规模数据的存储。

## NoSQL 能干嘛
1. 易扩展
    - NoSQL 数据库种类繁多，但是有一个共同的特点都是去掉关系数据库的关系型特性。
    - 数据之间无关系，这样就非常容易扩展，也就在无形之间，在架构的层面上带来了可扩展的能力。

2. 大数据量高性能
    - NoSQL 数据库都具有非常高的读写性能，尤其在大数据量下，同样表现优秀。
    - 这得益于它的无关系性，数据库的结构简单。
    - 一般 MySQL 使用 Query Cache，每次表的更新 Cache 就是一种大粒度的 Cache，在针对 web2.0 的交互频繁的应用，Cache 性能不高。
    - NoSQL 的 Cache 是记录级的，是一种细粒度的 Cache，所以 NoSQL 在这个层面上来说就要性能高很多了。

3. 多样灵活的数据模型
    - NoSQL 无需事先要为存储的数据建立字段，随时可以存储自定义的数据格式。
    - 在关系型数据库里，增删字段是一件非常麻烦的事情。如果是非常大数据量的表，增加字段简直是噩梦。

4. 传统 RDBMS VS NoSQL
    - RDBMS
        - 高度组织化结构化语言
        - 结构化查询语言(SQL)
        - 数据和关系都存储在单独的表中
        - 数据操纵语言，数据定义语言
        - 严格的一致性
        - 基础事物
    - NoSQL
        - 代表着不仅仅是 SQL
        - 没有声明性查询语言
        - 没有预定义的模式
        - 键值对存储，列存储，文档存储，图形数据库
        - 最终一致性，而非 ACID 属性
        - CAP 定理
        - 高性能，高可用性和可伸缩性

## 互联网的趋势
1. 大数据时代特点
    - 海量 Volume
    - 多样 Variety
    - 实时 Velocity

2. 互联网需求
    - 高并发
    - 高可扩
    - 高性能

## NoSQL 数据模型简介
1. 聚合模型
    - K-V 键值对
    - Bson
    - 列族
    - 图形

## NoSQL 数据库的四大分类
1. K-V 键值
    - 新浪：BerkeleyDB + Redis
    - 美团：Redis + tair
    - 阿里、百度：Memcached + Redis

2. 文档型数据库
    - CouchDB
    - MongoDB
        - MongoDB 是一个基于分布式文件存储的数据库，由 C++ 语言编写。旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。
        - MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。

3. 列存储数据库
    - Cassandra，HBase
    - 分布式文件系统

4. 图关系数据库
    - 它不是放图形的，放的是关系比如：朋友圈社交网络、广告推荐系统
    - 社交网络，推荐系统等。专注于构建关系图谱。
    - Neo4j，InfoGrid

5. 对比

| 分类 | Examples 举例 | 典型应用场景 | 数据模型 | 优点 | 缺点 |
| :---: | :---: | :---: | :---: | :---: | :---: |
| 键值(key-value) | Tokyo，Cabinet，Redis，Voldmort，Oracle BDB | 内容缓存，主要用于处理大量数据的高访问负载，也用于一些日志系统等等 | key 指向 value 的键值对，通常用 hash table 来实现 | 查找速度快 | 数据无结构化，通常只被当作字符串或者二进制数据 |
| 列存储数据库 | Cassandra，HBase，Riak | 分布式的文件系统 | 以列簇式存储，将同一列数据存在一起 | 查找速度快，可扩展性强，更容易进行分布式扩展 | 功能相对局限 |
| 文档型数据库 | CouchDB，MongoDB | Web 应用(与 Key-Value 类似，Value 是结构化的，不同的是数据库能够了解 Value 的内容) | Key-Value 对应的键值对，Value 为结构化数据 | 数据结构要求不严格，表结构可变，不需要像关系型数据库一样需要预先定义表结构 | 查询性能不高，而且缺乏统一的查询语言 |
| 图形数据库 | Neo4J，InfoGrid，Infinite Graph| 社交网络，推荐系统等，专注于构建关系图谱 | 图结构 | 利用图结构相关算法 | 很多时候需要对整个图做计算才能得出需要的信息，而且这种结构不太好做分布式的集群方案 |

## 分布式数据库中 CAP 原理 CAP + BASE
### 传统的 ACID
1. ACID 基本介绍
    - 关系型数据库遵循 ACID 规则，事务在英文中是 transaction，和现实世界中的交易很类似，它有四个特性。

2. 原子性
    - A(Atomicity) 原子性：原子性很容易理解，也就是说事务里的所有操作要么全部做完，要么都不做，事务成功的条件是事务里的所有操作都成功，只要有一个操作失败，整个事务就失败，需要回滚。
    - 比如银行转账，从 A 账户转 100 元至 B 账户，分为两个步骤：
        - 从 A 账户取 100 元
        - 存入 100 元至 B 账户
        - 这两步要么一起完成，要么一起不完成。

3. 一致性
    - C(Consistency) 一致性：一致性也就是说数据库要一直处于一致的状态，事务的运行不会改变数据库原来的一致性约束。

4. 独立性
    - I(Isolation) 独立性：所谓的独立性是指并发的事务之间不会相互影响，如果一个事务要访问的数据正在被另一个事务修改，只要另外一个事务未提交，它所访问的数据就不受未提交事务的影响。
    - 比如现有个交易是从 A 账户转 100 元至 B 账户，在这个交易还未完成的情况下，如果此时 B 查询自己的账户，是看不到新增加的 100 元的。

5. 持久性
    - D(Durability) 持久性：持久性是指一旦事务提交，它所做的修改将会永久的保存在数据上，即使出现宕机也不会丢失。

### CAP
1. 概述
    - CAP 理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，最多只能同时较好的满足两个。
    - 因此，根据 CAP 原理将 NoSQL 数据库分为满足 CA 原则、满足 CP 原则、满足 AP 原则三大类：
        - CA: 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。
        - CP: 满足一致性，分区容忍的系统，通常性能不是特别高。
        - AP: 满足可用性，分区容忍的系统，通常对一致性要求低一些。

2. CAP 的 3 进 2
- 概述
```
1. CAP 理论就是说在分布式存储系统中，最多只能实现上面的两点。
2. 由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的。
3. 所以，我们只能在一致性和可用性之间进行权衡，没有 NoSQL 系统同时保证这三点。
```

3. CAP 应用
    - CA 传统 Oracle 数据库
    - AP 大多数网站架构的选择
    - CP Redis、MongoDB

4. 一致性和可用性的抉择
    - 对于 web2.0 网站来说，关系数据库的很多主要特性往往无用武之地
    - 数据库事务一致性需求：
        - 很多 web 实时系统并不要求严格的数据库事务，对读一致性的要求很低，有些场合对写一致性要求并不高。运行实现最终一致性
    - 数据库的写实时性和读实时性需求
        - 对关系数据库来说，插入一条数据之后立刻查询，是肯定可以读出来这条数据的，但是对于很多 web 应用来说，并不要求那么高的实时性，比如说发一条消息，过几秒乃至十几秒之后，我们订阅者才看到这条动态是完全可以接受的。
    - 对于复杂的 SQL 查询，特别是多表关联查询的需求
        - 任何大数据量的 web 系统，存在多个表的关联查询，以及复杂的数据分析类型的报表查询，特别是 SNS 类型的网站，从需求以及产品设计角度，就避免了这种情况的产生。往往更多的只是单表的主键查询，以及单表的简单条件分页查询，SQL 的功能被极大的弱化了。

### BASE
1. 概述
    - BASE 就是为了解决关系数据库强一致性引起的问题而引起的可用性降低而提出的解决方案。
    - BASE 其实是下面三个术语的缩写：
        - 基本可用(Basically Available)
        - 软状态(Soft state)
        - 最终一致(Eventually consistent)
    - 它的思想的是通过让系统放松对某一时刻数据一致性的要求来换取系统整体伸缩性和性能上改观。

### 分布式 + 集群
1. 概述
    - 分布式系统(Distributed system)：由多台计算机和通信的软件组件通过计算机网络连接(本地网络或广域网)组成。
    - 分布式系统是建立在网络之上的软件系统。正是因为软件的特性，所以分布式系统具有高度的内聚性和透明性。因此，网络和分布式系统之间的区别更多的在于软件，而不是硬件。
    - 分布式系统可以应用在不同的平台上如：PC、工作站、局域网和广域网上等。
    - 简单来讲：
        - 分布式：不同的多台服务器上面部署不同的服务模块，它们之间通过 Rpc/Rmi 之间通信和调用，对外提供服务和组内协作。
        - 集群：不同的多台服务器上面部署相同的服务模块，通过分布式调度软件进行统一调度，对外提供服务和访问。
