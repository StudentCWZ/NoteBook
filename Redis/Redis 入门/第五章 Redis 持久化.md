# Redis 持久化
## RDB(Redis DataBase)
### 基本介绍
1. 在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的 SnapShot 快照，它恢复时是将快照文件直接读到内存里。
2. Redis 会单独创建 fork 一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。
3. 整个过程中，主进程是不进行任何 IO 操作，这就确保了极高的性能。
4. 如果需要进行大规模数据的恢复，且对于数据的恢复的完整性不是非常敏感，那 RDB 方式要比 AOF 方式更加的高效，RDB 的缺点是最后一次持久化的数据可能丢失。

### Fork
1. Fork 的作用是复制一个与当前进程一样的进程，新进程的所有数据(变量、环境变量、程序计数器等)，数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程。

### 如何触发 RDB 快照
1. 配置文件中默认的快照配置
    - 冷拷贝后重新使用

2. 命令 save 或者是 bgsave
    - Save: Save 时只管保存，其他不管，全部阻塞
    - BgSave: Redis 会在后台异步进行快照操作，快照同时还可以响应客户端请求。可以通过 lastsave 命令获取最后一次成功执行快照的时间。

3. 注意
    - 执行 flushall 命令，也会产生 dump.rdb 文件，但里面是空的，无意义。

### 如何恢复
1. 将备份文件 dump.rdb 移动到 redis 安装目录并启动服务即可。

### 优势
1. 适合大规模的数据恢复
2. 对数据完整性和一致性要求不高

### 劣势
1. 在一定间隔时间做一次备份，所以如果 redis 意外 down 掉的话，就会丢失最后一次快照的所有修改。
2. Fork 的时候，内存中的数据被克隆了一份，大致 2 倍的膨胀性需要考虑。

### 停止
1. 动态所有停止 RDB 保存规则的方法：redis-cli config set save ""

### RDB 总结
1. RDB 是一个非常紧凑的文件
2. RDB 在保存 RDB 文件时，父进程唯一需要做的就是 fork 一个子进程，接下来的工作全部由子进程来做，父进程不需要再做其他 IO 操作，所以 RDB 持久化方式可以最大化 redis 的性能。
3. 与 AOF 相比，在恢复大的数据集的时候， RDB 方式会更快些。
4. RDB 方式中，数据丢失风险大
5. RDB 需要经常 fork 子进程来保存数据集到硬盘上，当数据集比较大的时候，fork 的过程是非常耗时的，可能会导致 redis 在一些毫秒级不能响应客户端请求。

## AOF(Append Only File)
### 基本介绍
1. AOF: 以日志的形式来记录每个写操作，将 Redis 执行过的所有写指令记录下来(读操作不记录)，只许追加文件但不可以改写文件。
2. redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次已完成数据的恢复工作。

### AOF 启动/修复/恢复
1. 正常恢复
    - 启动：设置 Yes 。
    - 将有数据的 aof 文件复制一份保存到对应目录(config get dir)。
    - 恢复：重启 redis 然后重新加载。

2. 异常恢复
    - 启动：设置 Yes
    - 备份被写坏的 AOF 文件
    - 修复：Redis-check-aof --fix 进行修复
    - 恢复：重启 redis 然后重新加载

3. Rewrite
    - 基本介绍
        - AOF 采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制，当 AOF 文件的大小超过所设定的阈值时，Redis 就会启动 AOF 文件的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令 bgrewriteaof 。
    - 重写原理
        - AOF 文件持续增长而过大，会 fork 出一条新进程来将文件重写，遍历新进程的内存中数据，每条记录有一条的 Set 语句。
        - 重写 aof 文件的操作，并没有读取旧的 aof 文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的 aof 文件，这点和快照有点类似。
    - 触发机制
        - Redis 会记录上次重写时的 AOF 大小，默认配置是当 AOF 文件大小是上次 rewrite 后大小的一倍且文件大于 64M 时触发。

4. 优势
    - 每秒同步：appendfsync always 同步持久化，每次发生数据变更会被立即记录到磁盘，性能较差但数据完整性比较好。
    - 每修改同步：appendfsync everysec 异步操作，每秒记录，如果一秒宕机，有数据丢失
    - 不同步：appendfsync no 从不同步

5. 劣势
    - 相同数据集的数据而言 aof 文件要远大于 rdb 文件，恢复速度慢于 rdb。
    - Aof 运行效率要慢于 rdb，每秒同步策略较好，不同步效率和 rdb 相同。

### AOF 总结
1. AOF 文件是一个只进行追加的日志文件。
2. Redis 可以在 AOF 文件体积变得过大时，自动地在后台对 AOF 进行重写。
3. 对于相同的数据集，AOF 文件的体积通常要大于 RDB 文件的体积
4. 根据所使用的 fsync 策略， AOF的速度可能会慢于 RDB。

## 总结
1. RDB 持久化方式能够在指定的时间间隔能对你的数据进行快照存储
2. AOF 持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF 命令以 Redis 协议追加保存每次写的操作到文件末尾
3. Redis 还能对 AOF 文件进行后台重写，使得 AOF 文件的体积不至于过大
4. 只做缓存：如果你只希望你的数据在服务端运行的时候存在，你也可以不使用任何持久方式
5. 同时开启两种持久化方式
    - 在这种情况下，当 Redis 重启的时候会优先载入 AOF 文件来恢复原始的数据，因为在通常情况下 AOF 文件保存的数据集要比 RDB 文件保存的数据集要完整
    - RDB 的数据不实时，同时使用两者时，服务器重启也只会找 AOF 文件那要不要只使用 AOF ？建议不要，因为 RDB 更适合用于备份数据库 (AOF 在不断变化不好备份)，快速重启，而且不会有 AOF 可能潜在的 bug ，留着作为一个万一的手段
